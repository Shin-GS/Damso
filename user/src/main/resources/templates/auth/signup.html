<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head(additionalCss='/css/auth/signup.css')">
    <title>회원가입 - 담소</title>
</head>
<body class="signup-page">
<!-- Header -->
<header th:replace="fragments/header :: header"></header>

<!-- Main Content -->
<main>
    <section class="signup-container">
        <h2>회원가입</h2>
        <form id="signup-form">
            <!-- 이름 입력 -->
            <div class="form-group">
                <label for="name">이름</label>
                <input type="text" id="name" name="name" placeholder="이름을 입력하세요" required>
            </div>

            <!-- 이메일 입력 및 인증 -->
            <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" id="email" name="email" placeholder="이메일을 입력하세요" required>
                <button type="button" id="email-verify-button" class="btn-verify">중복 확인</button>
            </div>

            <!-- 비밀번호 입력 -->
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요" required>
            </div>

            <!-- 비밀번호 확인 -->
            <div class="form-group">
                <label for="confirm-password">비밀번호 확인</label>
                <input type="password" id="confirm-password" name="confirmPassword" placeholder="비밀번호를 다시 입력하세요"
                       required>
            </div>

            <!-- 약관 동의 -->
            <div class="terms">
                <label><input type="checkbox" id="termsAgreed" name="termsAgreed" required> 약관에 동의합니다</label>
            </div>

            <!-- 회원가입 버튼 -->
            <button type="button" class="btn-signup" disabled>회원가입</button>
        </form>

        <!-- SNS 회원가입 -->
        <div class="social-signup">
            <p>소셜 계정으로 회원가입</p>
            <a href="/oauth2/authorization/google" class="btn-social google">Google 로그인</a>
            <a href="/oauth2/authorization/x" class="btn-social x">X 로그인</a>
            <a href="/oauth2/authorization/instagram" class="btn-social instagram">Instagram 로그인</a>
            <a href="/oauth2/authorization/naver" class="btn-social naver">네이버 로그인</a>
        </div>

        <!-- 로그인 링크 -->
        <div class="helper-links">
            <p>이미 계정이 있으신가요? <a th:href="@{/login}">로그인</a></p>
        </div>
    </section>
</main>

<!-- Footer -->
<footer th:replace="fragments/footer :: footer"></footer>

<script>
    // DOM 요소 참조
    const elements = {
        nameInput: document.getElementById("name"),
        emailInput: document.getElementById("email"),
        emailVerifyButton: document.getElementById("email-verify-button"),
        passwordInput: document.getElementById("password"),
        confirmPasswordInput: document.getElementById("confirm-password"),
        termsCheckbox: document.getElementById("termsAgreed"),
        signupButton: document.querySelector(".btn-signup"),
    };

    // 상태 변수
    let emailVerified = false;

    // 정규식 패턴
    const patterns = {
        name: /^[a-zA-Z가-힣]{2,50}$/,
        email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
        password: /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,64}$/,
    };

    // 에러 메시지 처리
    const errorHandling = {
        show: (element, message) => {
            let errorMessage = element.nextElementSibling;
            if (!errorMessage || !errorMessage.classList.contains("error-message")) {
                errorMessage = document.createElement("div");
                errorMessage.classList.add("error-message");
                element.after(errorMessage);
            }
            errorMessage.textContent = message;
        },
        clear: (element) => {
            const errorMessage = element.nextElementSibling;
            if (errorMessage && errorMessage.classList.contains("error-message")) {
                errorMessage.textContent = "";
            }
        },
    };

    // 유효성 검사
    const validators = {
        name: () => {
            const {nameInput} = elements;
            if (!patterns.name.test(nameInput.value)) {
                errorHandling.show(nameInput, "이름은 2~50자의 한글, 영어만 가능합니다.");
                return false;
            }
            errorHandling.clear(nameInput);
            return true;
        },
        email: () => {
            const {emailInput} = elements;
            if (!patterns.email.test(emailInput.value)) {
                errorHandling.show(emailInput, "유효한 이메일 형식을 입력하세요.");
                return false;
            }
            errorHandling.clear(emailInput);
            return true;
        },
        password: () => {
            const {passwordInput, confirmPasswordInput} = elements;
            let valid = true;

            if (!patterns.password.test(passwordInput.value)) {
                errorHandling.show(passwordInput, "비밀번호는 8~64자, 대문자, 소문자, 숫자, 특수문자를 포함해야 합니다.");
                valid = false;
            } else {
                errorHandling.clear(passwordInput);
            }

            if (passwordInput.value !== confirmPasswordInput.value) {
                errorHandling.show(confirmPasswordInput, "비밀번호가 일치하지 않습니다.");
                valid = false;
            } else {
                errorHandling.clear(confirmPasswordInput);
            }

            return valid;
        },
    };

    // 이메일 중복 확인
    elements.emailVerifyButton.addEventListener("click", () => {
        if (!validators.email()) return;

        fetch("/api/auth/signup/check-email", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({email: elements.emailInput.value}),
        })
            .then((response) => {
                if (response.ok) {
                    alert("이메일 중복 확인이 완료되었습니다.");
                    emailVerified = true;
                } else {
                    alert("이미 사용 중인 이메일입니다.");
                    emailVerified = false;
                }
                enableSignup();
            })
            .catch(() => alert("이메일 확인 중 오류가 발생했습니다."));
    });

    // 회원가입 버튼 활성화
    const enableSignup = () => {
        const {nameInput, emailInput, passwordInput, confirmPasswordInput, termsCheckbox, signupButton} = elements;

        const allValid =
            validators.name() &&
            validators.email() &&
            validators.password() &&
            termsCheckbox.checked &&
            emailVerified;

        signupButton.disabled = !allValid;
    };

    // 회원가입 요청
    elements.signupButton.addEventListener("click", () => {
        const requestData = {
            name: elements.nameInput.value,
            email: elements.emailInput.value,
            password: elements.passwordInput.value,
            termsAgreed: elements.termsCheckbox.checked,
        };

        fetch("/api/auth/signup", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(requestData),
        })
            .then((response) => {
                if (response.ok) {
                    alert("회원가입이 완료되었습니다!");
                    window.location.href = "/login";
                } else {
                    response.json().then((data) => alert(data.message || "회원가입 중 오류가 발생했습니다."));
                }
            })
            .catch(() => alert("네트워크 오류가 발생했습니다. 다시 시도해주세요."));
    });

    // 이벤트 리스너 등록
    elements.nameInput.addEventListener("input", enableSignup);
    elements.passwordInput.addEventListener("input", enableSignup);
    elements.confirmPasswordInput.addEventListener("input", enableSignup);
    elements.termsCheckbox.addEventListener("change", enableSignup);
</script>
</body>
</html>
