<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="views/layout :: head(additionalCss='/css/story/quill.snow.css,/css/story/cropper.min.css,/css/story/dropzone.min.css',
additionalScript='/script/story/quill.min.js,/script/story/cropper.min.js,/script/story/dropzone.min.js,/script/story/sortable.min.js,/script/story/editor/textEditor.js,/script/story/editor/imageEditor.js,/script/story/editor/videoEditor.js')">
    <title>이야기 편집</title>
</head>
<body class="content-edit-page flex flex-col min-h-screen bg-gray-100">
<!-- Header -->
<header th:replace="views/layout :: header"></header>

<main class="flex-grow flex justify-center items-center py-12">
    <section class="content-edit-container bg-white shadow-lg rounded-lg p-8 max-w-4xl w-full">
        <h1 class="text-2xl font-bold mb-6">이야기 편집</h1>
        <form id="storyEditForm" class="space-y-6">
            <input type="hidden" id="storyId" name="storyId" th:value="${story.id}">
            <div>
                <label class="block font-medium mb-2">이야기 제목</label>
                <label>
                    <input type="text"
                           id="title"
                           name="title"
                           th:pattern="${storyRegexPattern.TITLE.pattern}"
                           th:title="${storyRegexPattern.TITLE.message}"
                           th:value="${story.title}"
                           class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400"
                           required>
                    <small class="text-gray-500" th:text="${storyRegexPattern.TITLE.message}"></small>
                </label>
            </div>

            <div>
                <label class="block font-medium mb-2">이야기 유형</label>
                <label>
                    <select id="storyTypeSelect"
                            name="storyType"
                            class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400"
                            th:hx-get="@{'/hx/stories/' + ${story.id} + '/edit'}"
                            hx-include="[name='storyType']"
                            hx-confirm="이야기 유형을 변경하면 기존에 작성한 내용이 삭제됩니다. 계속하시겠습니까?"
                            hx-target="#editor">
                        <option th:each="option : ${storyTypes}"
                                th:value="${option.code}"
                                th:text="${option.value}"
                                th:selected="${option.code == story.storyType.code}">
                        </option>
                    </select>
                </label>
            </div>

            <section id="editor"
                     class="mt-8"
                     th:hx-get="@{'/hx/stories/' + ${story.id} + '/edit'}"
                     hx-include="[name='storyType']" hx-trigger="load" hx-target="this">
            </section>

            <div>
                <label class="block font-medium mb-2">댓글 설정</label>
                <label>
                    <select name="commentType"
                            class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400">
                        <option th:each="option : ${commentTypes}"
                                th:value="${option.code}"
                                th:text="${option.value}"
                                th:selected="${option.code == story.commentType.code}">
                        </option>
                    </select>
                </label>
            </div>

            <div class="flex items-center">
                <label>
                    <input type="checkbox"
                           name="published"
                           th:checked="${story.published}"
                           class="form-checkbox h-5 w-5">
                </label>
                <span class="ml-2">이야기 발행</span>
            </div>

            <div class="flex justify-end space-x-4">
                <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                    저장
                </button>
                <a th:href="@{/}"
                   class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded">
                    취소
                </a>
            </div>
        </form>
    </section>
</main>

<!-- Footer -->
<footer th:replace="views/layout :: footer"></footer>

<script>
    // DOMContentLoaded 및 HTMX 요청 완료 후 비동기 초기화
    async function initializeEditors() {
        await initializeTextEditor();
        await initializeImageEditor();
        await initializeVideoEditor();
    }

    // DOM이 완전히 로드된 후 초기화
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeEditors();

        document.getElementById('storyEditForm')
            .addEventListener('submit', handleFormSubmit);
    });

    // HTMX 요청 완료 후 비동기 초기화
    document.body.addEventListener('htmx:afterSwap', async (event) => {
        if (event.detail.target.id === 'editor') {
            await initializeEditors();
        }
    });

    async function handleFormSubmit(event) {
        event.preventDefault();

        const form = document.getElementById('storyEditForm');
        const storyId = document.getElementById('storyId').value;
        const title = document.getElementById('title').value;
        const storyType = document.getElementById('storyTypeSelect').value;
        const commentType = form.commentType.value;
        const published = form.published.checked;

        // JSON 객체 생성
        const payload = {
            storyId: storyId,
            title: title,
            storyType: storyType,
            commentType: commentType,
            published: published,
        };

        if (storyType === 'TEXT') {
            const textContent = document.querySelector('.ql-editor').innerHTML;
            const plainText = document.querySelector('.ql-editor').textContent;
            payload.text = textContent;
            payload.plainText = plainText;
        }

        if (storyType === 'IMAGE') {
            payload.files = Array.from(document.querySelectorAll('#sortable-list img')).map(img => img.src);
        }

        if (storyType === 'VIDEO') {
            const videoElement = document.querySelector('#uploaded-videos video');
            payload.files = videoElement ? [videoElement.querySelector('source')?.src || videoElement.src] : [];
        }

        try {
            const response = await fetch(`/api/stories/${storyId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                alert('스토리가 성공적으로 저장되었습니다!');
            } else {
                const error = await response.json();
                alert(`저장 실패: ${error.message || '알 수 없는 오류'}`);
            }
        } catch (error) {
            console.error('API 호출 중 오류 발생:', error);
            alert('스토리 저장 중 문제가 발생했습니다.');
        }
    }
</script>
</body>
</html>
