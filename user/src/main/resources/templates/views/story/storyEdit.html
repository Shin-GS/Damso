<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="views/layout :: head(additionalCss='/css/story/quill.snow.css,/css/story/cropper.min.css,/css/story/dropzone.min.css',
additionalScript='/script/story/quill.min.js,/script/story/cropper.min.js,/script/story/dropzone.min.js,/script/story/sortable.min.js,/script/story/editor/textEditor.js,/script/story/editor/imageEditor.js,/script/story/editor/videoEditor.js')">
    <title>이야기 편집</title>
</head>
<body class="content-edit-page flex flex-col min-h-screen bg-gray-100">
<!-- Header -->
<header th:replace="views/layout :: header"></header>

<main class="flex-grow flex justify-center items-center py-12">
    <section class="content-edit-container bg-white shadow-lg rounded-lg p-8 max-w-5xl w-full">
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6">
            <p>
                ⚠️
                <strong>주의:</strong> 현재 작성된 내용은 <strong>임시 저장</strong> 상태입니다.
                <strong>발행</strong> 버튼을 눌러야 최종적으로 적용됩니다.
            </p>
        </div>

        <h1 class="text-2xl font-bold mb-6">이야기 편집</h1>
        <form id="storyEditForm" class="space-y-6">
            <input type="hidden" id="storyId" name="storyId" th:value="${story.id}">

            <!-- 이야기 제목 -->
            <div>
                <label class="block font-medium mb-2">이야기 제목</label>
                <label>
                    <input type="text"
                           id="title"
                           name="title"
                           th:pattern="${storyRegexPattern.TITLE.pattern}"
                           th:title="${storyRegexPattern.TITLE.message}"
                           th:value="${story.title}"
                           class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400"
                           required>
                    <small class="text-gray-500" th:text="${storyRegexPattern.TITLE.message}"></small>
                </label>
            </div>

            <!-- 페이지 편집 -->
            <section id="pages-container" class="mt-8"
                     hx-get="@{'/hx/stories/' + ${story.id} + '/pages'}"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                <!-- 페이지 목록 동적 로드 -->
            </section>

            <div class="flex justify-between mt-4">
                <button type="button" id="add-page-button"
                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded"
                        hx-post="@{'/hx/stories/' + ${story.id} + '/pages'}"
                        hx-target="#pages-container"
                        hx-swap="beforeend">
                    페이지 추가
                </button>
            </div>

            <!-- 댓글 설정 -->
            <div>
                <label class="block font-medium mb-2">댓글 설정</label>
                <label>
                    <select name="commentType"
                            class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400">
                        <option th:each="option : ${commentTypes}"
                                th:value="${option.code}"
                                th:text="${option.value}"
                                th:selected="${option.code == story.commentType.code}">
                        </option>
                    </select>
                </label>
            </div>

            <!-- 발행 체크박스 -->
            <div class="flex items-center">
                <label>
                    <input type="checkbox"
                           name="published"
                           th:checked="${story.published}"
                           class="form-checkbox h-5 w-5">
                </label>
                <span class="ml-2">이야기 발행</span>
            </div>

            <!-- 임시저장, 수정취소, 이야기 발행 버튼 -->
            <div class="flex justify-end space-x-4">
                <button type="button"
                        id="temporarySaveButton"
                        class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded">
                    임시 저장
                </button>
                <button type="button"
                        id="cancelEditButton"
                        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded">
                    수정 취소
                </button>
                <button type="submit"
                        id="publishButton"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                    이야기 발행
                </button>
            </div>
        </form>
    </section>
</main>

<!-- Footer -->
<footer th:replace="views/layout :: footer"></footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const pagesContainer = document.getElementById('pages-container');

        document.body.addEventListener('htmx:afterRequest', (event) => {
            if (event.detail.path.includes('/pages')) {
                initializeEditors();
            }
        });

        // 임시 저장 버튼 로직
        document.getElementById('temporarySaveButton').addEventListener('click', async () => {
            const storyId = document.getElementById('storyId').value;
            const title = document.getElementById('title').value;
            const payload = {title};

            try {
                const response = await fetch(`/api/stories/${storyId}/temporary-save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    alert('임시 저장 완료!');
                } else {
                    alert('임시 저장 실패!');
                }
            } catch (error) {
                console.error('임시 저장 중 오류:', error);
            }
        });

        // 수정 취소 버튼 로직
        document.getElementById('cancelEditButton').addEventListener('click', () => {
            if (confirm('수정을 취소하시겠습니까? 저장되지 않은 내용은 사라집니다.')) {
                location.reload();
            }
        });
    });
</script>
</body>
</html>
