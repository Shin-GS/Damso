<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="views/layout :: head(additionalCss='/css/story/quill.snow.css,/css/story/cropper.min.css,/css/story/dropzone.min.css,/css/story/uppy.min.css',
additionalScript='/script/story/quill.min.js,/script/story/cropper.min.js,/script/story/dropzone.min.js,/script/story/uppy.min.js')">
    <title>이야기 편집</title>
</head>
<body class="content-edit-page flex flex-col min-h-screen bg-gray-100">
<!-- Header -->
<header th:replace="views/layout :: header"></header>

<main class="flex-grow flex justify-center items-center py-12">
    <section class="content-edit-container bg-white shadow-lg rounded-lg p-8 max-w-4xl w-full">
        <h1 class="text-2xl font-bold mb-6">이야기 편집</h1>

        <form th:action="@{'/story/' + ${story.id} + '/edit'}"
              method="PUT"
              th:object="${story}"
              class="space-y-6">
            <div>
                <label class="block font-medium mb-2">이야기 제목</label>
                <label>
                    <input type="text"
                           th:value="${story.title}"
                           class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400" required>
                </label>
            </div>

            <div>
                <label class="block font-medium mb-2">이야기 유형</label>
                <label>
                    <select class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400"
                            name="storyType"
                            th:value="${story.storyType}"
                            th:hx-get="@{'/hx/stories/' + ${story.id} + '/edit'}"
                            hx-include="[name='storyType']"
                            hx-confirm="이야기 유형을 변경하면 기존에 작성한 내용이 삭제됩니다. 계속하시겠습니까?"
                            hx-target="#editor">
                        <option value="TEXT">텍스트</option>
                        <option value="IMAGE">이미지</option>
                        <option value="VIDEO">비디오</option>
                    </select>
                </label>
            </div>

            <div>
                <section id="editor" class="mt-8"
                         th:hx-get="@{'/hx/stories/' + ${story.id} + '/edit'}"
                         hx-include="[name='storyType']"
                         hx-trigger="load"
                         hx-target="this">
                </section>
            </div>

            <div>
                <label class="block font-medium mb-2">댓글 설정</label>
                <label>
                    <select class="w-full border rounded-md px-4 py-2 focus:ring focus:ring-blue-400"
                            name="commentType"
                            th:value="${story.commentType}">
                        <option value="NONE">댓글 없음</option>
                        <option value="CUT">컷별 댓글</option>
                        <option value="ALL">전체 댓글</option>
                    </select>
                </label>
            </div>

            <div>
                <label class="flex items-center">
                    <input type="checkbox" th:value="${story.published}" class="form-checkbox h-5 w-5">
                    <span class="ml-2">이야기 발행</span>
                </label>
            </div>

            <div class="flex justify-end space-x-4">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                    저장
                </button>
                <a th:href="@{/}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded">
                    취소
                </a>
            </div>
        </form>
    </section>
</main>

<!-- Footer -->
<footer th:replace="views/layout :: footer"></footer>

<script>
    // 텍스트 에디터 초기화
    async function initializeTextEditor() {
        const editorContainer = document.querySelector('.quill-editor');
        if (editorContainer) {
            const quill = new Quill(editorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{'header': [1, 2, 3, false]}],
                        [{'list': 'ordered'}, {'list': 'bullet'}],
                        [{'align': []}],
                        ['image', 'link'],  // 사진 가능성 해상
                        ['clean']
                    ]
                }
            });

            // 이미지 업로드
            quill.getModule('toolbar').addHandler('image', () => {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', '.png,.jpg,.jpeg,.gif,.bmp,.webp');
                input.click();

                input.onchange = async () => {
                    const file = input.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('file', file);

                        const res = await fetch('/api/upload/image', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await res.json();
                        if (data && data.result && data.result.url) {
                            const range = quill.getSelection();
                            quill.insertEmbed(range.index, 'image', data.result.url);

                        } else {
                            alert('이미지 업로드 실패: 서버 응답에 URL이 없습니다.');
                        }
                    }
                };
            });
        }
    }

    // 이미지 에디터 초기화
    let filesQueue = [];
    let currentFileIndex = 0;

    async function initializeImageEditor() {
        new Dropzone("#uploadDropzone", {
            url: '/api/upload/image',
            autoProcessQueue: false,
            acceptedFiles: 'image/*',
            init: function () {
                this.on("addedfile", (file) => {
                    filesQueue.push(file);
                    if (filesQueue.length === 1) {
                        showEditModal(file);
                    }
                });

                // 업로드 성공 후 이미지 정렬 섹션으로 이동
                this.on("success", function (file, response) {
                    if (response && response.result.url) {
                        addImageToSortableList(response.result.url);
                        this.removeFile(file);  // 업로드 완료된 파일은 Dropzone에서 제거
                    }
                });
            }
        });
    }

    // 정렬 섹션에 이미지 추가
    function addImageToSortableList(imageUrl) {
        const sortableContainer = document.querySelector('.sortable-list');

        const imageDiv = document.createElement('div');
        imageDiv.classList.add('p-2', 'bg-white', 'shadow', 'rounded');
        imageDiv.innerHTML = `<img src="${imageUrl}" class="w-full rounded">`;

        sortableContainer.appendChild(imageDiv);
    }

    // 편집 모달 표시 및 Cropper 초기화
    function showEditModal(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const modal = document.querySelector('#image-edit-modal');
            const image = modal.querySelector('#image-edit-modal-image');
            image.src = e.target.result;

            modal.classList.remove('hidden');

            if (image.cropper) {
                image.cropper.destroy();
            }
            new Cropper(image, {
                aspectRatio: 1,
                autoCropArea: 0.8,
                viewMode: 1
            });
        };
        reader.readAsDataURL(file);
    }

    // 다음 파일 편집 진행
    function processNextFile() {
        currentFileIndex++;
        if (currentFileIndex < filesQueue.length) {
            showEditModal(filesQueue[currentFileIndex]);
        } else {
            filesQueue = [];
            currentFileIndex = 0;
        }
    }

    // 이벤트 위임 - 편집 적용 및 건너뛰기
    document.addEventListener('click', (event) => {
        const modal = document.querySelector('#image-edit-modal');
        const cropperImage = modal.querySelector('#image-edit-modal-image');
        const dropzone = Dropzone.forElement("#uploadDropzone");

        if (event.target.matches('.apply-edit-button')) {
            const canvas = cropperImage.cropper.getCroppedCanvas();
            canvas.toBlob(blob => {
                const newFile = new File([blob], filesQueue[currentFileIndex].name, {type: 'image/jpeg'});

                // 파일 업로드 및 즉시 처리
                dropzone.removeFile(filesQueue[currentFileIndex]);  // 기존 파일 제거
                dropzone.addFile(newFile);  // 새로운 파일 추가
                dropzone.processFile(newFile);  // 업로드 즉시 실행

                modal.classList.add('hidden');  // 모달 숨기기
                processNextFile();  // 다음 파일 처리
            });
        }

        if (event.target.matches('.skip-edit-button')) {
            dropzone.processFile(filesQueue[currentFileIndex]);  // 즉시 업로드
            modal.classList.add('hidden');
            processNextFile();
        }

        if (event.target.matches('.close-modal-button')) {
            modal.classList.add('hidden');
        }

        if (event.target.matches('.skip-all-edit-button')) {
            dropzone.processQueue();
            filesQueue = [];
        }
    });

    // 비디오 에디터 초기화
    async function initializeVideoEditor() {
        const videoUploadArea = document.querySelector('#video-upload-area');
        if (videoUploadArea) {
            const uppy = new window.Uppy.Uppy({  // window.Uppy로 변경
                restrictions: {
                    maxNumberOfFiles: 1,
                    maxFileSize: 500 * 1024 * 1024,  // 500MB 제한
                    allowedFileTypes: ['.mp4', '.mov', '.avi', '.mkv', '.wmv', '.flv']
                }
            })
                .use(Uppy.Dashboard, {
                    inline: true,
                    target: '#video-upload-area',
                    proudlyDisplayPoweredByUppy: false,
                    height: 300
                })
                .use(Uppy.XHRUpload, {
                    endpoint: '/api/upload/video',
                    fieldName: 'file'
                });

            // 업로드 제한 실패 시 경고
            uppy.on('restriction-failed', () => {
                alert('동영상은 하나만 업로드할 수 있습니다.');
            });
        }
    }

    // DOMContentLoaded 및 HTMX 요청 완료 후 비동기 초기화
    async function initializeEditors() {
        await initializeTextEditor();
        await initializeImageEditor();
        await initializeVideoEditor();
    }

    // DOM이 완전히 로드된 후 초기화
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeEditors();
    });

    // HTMX 요청 완료 후 비동기 초기화
    document.body.addEventListener('htmx:afterSwap', async (event) => {
        if (event.detail.target.id === 'editor') {
            await initializeEditors();
        }
    });
</script>
</body>
</html>
